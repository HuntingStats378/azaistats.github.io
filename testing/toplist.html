<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>YouTube Channel Live Chart (Bulk API)</title>
  <script src="https://cdn.plot.ly/plotly-2.24.2.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
    #chart { width: 100%; max-width: 1200px; margin: auto; }
    h1 { text-align: center; }
  </style>
</head>
<body>

<h1>Top 20 YouTube Channels (Live, Refresh Every 5s)</h1>
<div id="chart"></div>

<script>
  const COMMUNITRICS_API = 'https://api.communitrics.com/channels';
  const SCTOOLS_API_BASE = 'https://ests.sctools.org/api/get/';
  let cachedChannelList = [];

  // Utility functions
  function getRandomSample(array, size) {
    const shuffled = [...array].sort(() => 0.5 - Math.random());
    return shuffled.slice(0, size);
  }

  function chunkArray(arr, size) {
    const chunks = [];
    for (let i = 0; i < arr.length; i += size) {
      chunks.push(arr.slice(i, i + size));
    }
    return chunks;
  }

  async function fetchBulkStats(ids) {
    const idStr = ids.join(',');
    const res = await fetch(`${SCTOOLS_API_BASE}${idStr}`);
    const json = await res.json();
    return Object.values(json).map(entry => ({
      id: entry.info?.id,
      name: entry.info?.name,
      avatar: entry.info?.avatar,
      subs: entry.stats?.estCount || 0,
      daily: entry.averages?.daily || 0
    })).filter(ch => ch.id && ch.name && ch.avatar);
  }

  async function fetchAndRender() {
    if (cachedChannelList.length === 0) return;

    const sampleIDs = getRandomSample(cachedChannelList, 200);
    const chunks = chunkArray(sampleIDs, 50);
    const results = await Promise.all(chunks.map(fetchBulkStats));
    const data = results.flat();

    renderChart(data);
  }

  function renderChart(channels) {
    const top20 = channels
      .sort((a, b) => b.subs - a.subs)
      .slice(0, 20);

    const names = top20.map(ch => ch.name);
    const subs = top20.map(ch => ch.subs);
    const hoverText = top20.map(ch =>
      `${ch.name}<br>Subs: ${ch.subs.toLocaleString()}<br>Daily Avg: ${ch.daily.toLocaleString()}`
    );
    const avatars = top20.map(ch => ch.avatar);

    const trace = {
      type: 'bar',
      x: subs,
      y: names,
      orientation: 'h',
      text: hoverText,
      textposition: 'auto',
      marker: {
        color: 'rgba(30,144,255,0.6)',
        line: { width: 1, color: 'rgba(0,0,0,0.3)' }
      }
    };

    const layout = {
      title: 'Top 20 Channels by Estimated Subscribers',
      margin: { l: 160, r: 30, t: 50, b: 50 },
      yaxis: {
        automargin: true,
        tickfont: { size: 14 }
      },
      xaxis: {
        title: 'Subscribers',
        tickformat: ',d'
      },
      images: avatars.map((src, i) => ({
        source: src,
        xref: 'paper',
        yref: 'y',
        x: 0,
        y: names[i],
        xanchor: 'right',
        yanchor: 'middle',
        sizex: 0.07,
        sizey: 0.07,
        opacity: 1,
        layer: 'above'
      }))
    };

    Plotly.newPlot('chart', [trace], layout, {responsive: true});
  }

  // Initialize
  async function init() {
    try {
      const res = await fetch(COMMUNITRICS_API);
      cachedChannelList = await res.json();
      fetchAndRender(); // Initial render
      setInterval(fetchAndRender, 5000); // Every 5 seconds
    } catch (err) {
      console.error('Failed to load channel list:', err);
    }
  }

  init();
</script>

</body>
</html>
